(function(l,m){typeof exports=="object"&&typeof module<"u"?m(exports,require("chalk")):typeof define=="function"&&define.amd?define(["exports","chalk"],m):(l=typeof globalThis<"u"?globalThis:l||self,m(l.ParseThat={},l.chalk))})(this,function(l,m){"use strict";var ae=Object.defineProperty;var ue=(l,m,v)=>m in l?ae(l,m,{enumerable:!0,configurable:!0,writable:!0,value:v}):l[m]=v;var B=(l,m,v)=>(ue(l,typeof m!="symbol"?m+"":m,v),v);class v{constructor(e,t=void 0,n=0,r=!1){this.src=e,this.value=t,this.offset=n,this.isError=r}ok(e,t=0){return new v(this.src,e,this.offset+t)}err(e,t=0){const n=this.ok(e,t);return n.isError=!0,n}from(e,t=0){return new v(this.src,e,this.offset+t,this.isError)}getColumnNumber(){const e=this.offset,t=this.src.lastIndexOf(`
`,e),n=t===-1?e:e-(t+1);return Math.max(0,n)}getLineNumber(){const t=this.src.slice(0,this.offset).split(`
`).length-1;return Math.max(0,t)}addCursor(e="^",t=!1){return""}}const p=(i,...e)=>({}),z=/\s*/y,L=i=>{var t;if(i.offset>=i.src.length)return i;z.lastIndex=i.offset;const e=((t=i.src.match(z))==null?void 0:t[0])??"";return i.ok(i.value,e.length)},S=new Map;let j=0,I=0;const E=new Map,C=new Map;class f{constructor(e,t={}){B(this,"id",I++);this.parser=e,this.context=t}parse(e){return E.clear(),S.clear(),C.clear(),this.parser(new v(e)).value}getCijKey(e){return`${this.id}${e.offset}`}atLeftRecursionLimit(e){return(C.get(this.getCijKey(e))??0)>e.src.length-e.offset}memoize(){const e=t=>{const n=this.getCijKey(t),r=C.get(n)??0;let o=E.get(this.id);if(o&&o.offset>=t.offset)return o;if(this.atLeftRecursionLimit(t))return t.err(void 0);C.set(n,r+1);const s=this.parser(t);return o=E.get(this.id),o&&o.offset>s.offset?s.offset=o.offset:o||E.set(this.id,s),s};return new f(e,p("memoize",this))}mergeMemos(){const e=t=>{let n=E.get(this.id);if(n)return n;if(this.atLeftRecursionLimit(t))return t.err(void 0);const r=this.parser(t);return n=E.get(this.id),n||E.set(this.id,r),r};return new f(e,p("mergeMemo",this))}then(e){const t=n=>{const r=this.parser(n);if(!r.isError){const o=e.parser(r);if(!o.isError)return o.ok([r.value,o.value])}return n.err(void 0)};return new f(t,p("then",e))}or(e){const t=n=>{const r=this.parser(n);return r.isError?e.parser(n):r};return new f(t,p("or",e))}chain(e,t=!1){const n=r=>{const o=this.parser(r);return o.isError?o:o.value||t?e(o.value).parser(o):r};return new f(n,p("chain",e))}map(e,t=!1){const n=r=>{const o=this.parser(r);return!o.isError||t?o.ok(e(o.value)):o};return new f(n,p("map",this))}skip(e){const t=n=>{const r=this.parser(n);if(!r.isError){const o=e.parser(r);if(!o.isError)return o.ok(r.value)}return n.err(void 0)};return new f(t,p("skip",e))}next(e){const t=this.then(e).map(([,n])=>n);return t.context=p("next",e),t}opt(){const e=t=>{const n=this.parser(t);return n.isError?t.ok(void 0):n};return new f(e,p("opt",this))}not(e){const t=r=>this.parser(r).isError?r.ok(r.value):r.err(void 0),n=r=>{const o=this.parser(r);return o.isError||e.parser(r).isError?o:r.err(void 0)};return new f(e?n:t,p("not",e))}wrap(e,t){const n=e.next(this).skip(t);return n.context=p("wrap",e,t),n}trim(e=N){var n;if(((n=e.context)==null?void 0:n.name)==="whitespace"){const r=o=>{const s=L(o),a=this.parser(s);return a.isError?o.err(void 0):L(a)};return new f(r,p("trim",e))}const t=this.wrap(e,e.opt());return t.context=p("trim",e),t}many(e=0,t=1/0){const n=r=>{const o=[];let s=r;for(let a=0;a<t;a+=1){const c=this.parser(s);if(c.isError)break;o.push(c.value),s=c}return o.length>=e?s.ok(o):r.err([])};return new f(n,p("many",e,t))}sepBy(e,t=0,n=1/0){const r=o=>{const s=[];let a=o;for(let c=0;c<n;c+=1){const y=this.parser(a);if(y.isError)break;a=y,s.push(a.value);const A=e.parser(a);if(A.isError)break;a=A}return s.length>t?a.ok(s):o.err([])};return new f(r,p("sepBy",e))}debug(e="",t=console.log){return this}eof(){const e=this.skip(R());return e.context=p("eof",this),e}static lazy(e){const t=j++,n=r=>{if(S.has(t))return S.get(t).parser(r);const o=e();return o.id=t,S.set(t,o),o.parser(r)};return new f(n,p("lazy",e))}toString(e=0){return name}}function R(){const i=e=>e.offset>=e.src.length?e.ok(void 0):e.err();return new f(i,p())}function g(i,e,t){let n=t.value;const r=j++;t.value=function(){const o=s=>{if(S.has(r))return S.get(r).parser(s);const a=n.apply(this,arguments);return a.id=r,S.set(r,a),a.parser(s)};return new f(o,p("lazy",n))}}function h(...i){const e=t=>{for(const n of i){const r=n.parser(t);if(!r.isError)return r}return t.err(void 0)};return new f(i.length===1?i[0].parser:e,p("any",...i))}function w(...i){const e=t=>{const n=[];for(const r of i){const o=r.parser(t);if(o.isError)return o;o.value!==void 0&&n.push(o.value),t=o}return t.ok(n)};return new f(i.length===1?i[0].parser:e,p("all",...i))}function T(i){const e=t=>{const n=i.parser(t);return n.isError?t.err(void 0):t.ok(n.value)};return new f(e,p("lookAhead",i))}function O(i){const e=t=>{let n=i.parser(t);for(;n.offset>0&&n.isError;)n.offset-=1,n=i.parser(n);return n.isError?t.err(void 0):t.ok(n.value)};return new f(e,p("lookBehind",i))}function u(i){const e=t=>{if(t.offset>=t.src.length)return t.err(void 0);const n=t.src.slice(t.offset,t.offset+i.length);return n===i?t.ok(n,n.length):t.err(void 0)};return new f(e,p("string",i))}function d(i){const e=new RegExp(i,i.flags+"y"),t=n=>{var o;if(n.offset>=n.src.length)return n.err(void 0);e.lastIndex=n.offset;const r=(o=n.src.match(e))==null?void 0:o[0];return r?n.ok(r,r.length):r===""?n.ok(void 0):n.err(void 0)};return new f(t,p("regex",i))}const N=d(/\s*/);N.context.name="whitespace";var D=Object.defineProperty,F=Object.getOwnPropertyDescriptor,x=(i,e,t,n)=>{for(var r=n>1?void 0:n?F(e,t):e,o=i.length-1,s;o>=0;o--)(s=i[o])&&(r=(n?s(e,t,r):s(r))||r);return n&&r&&D(e,t,r),r};const G=u(",").trim(),P=u("=").trim(),W=u(";").trim(),$=u(".").trim(),q=u("?").trim(),K=u("?w").trim(),Z=u("??").trim(),H=u("|").trim(),U=u("+").trim(),Y=u("-").trim(),J=u("*").trim();u("/").trim();const Q=u(">>").trim(),V=u("<<").trim(),X=h(W,$);class k{identifier(){return d(/[_a-zA-Z][_a-zA-Z0-9]*/).trim()}literal(){return h(d(/[^"]+/).wrap(u('"'),u('"')),d(/[^']+/).wrap(u("'"),u("'"))).map(e=>({type:"literal",value:e}))}epsilon(){return h(u("epsilon"),u("ε"),u("ϵ")).trim().map(e=>({type:"epsilon",value:void 0}))}nonterminal(){return this.identifier().map(e=>({type:"nonterminal",value:e}))}group(){return this.expression().trim().wrap(u("("),u(")")).map(e=>({type:"group",value:e}))}eof(){return u("$").trim().map(e=>({type:"eof",value:e}))}regex(){return d(/[^\/]*/).wrap(u("/"),u("/")).map(e=>({type:"regex",value:new RegExp(e)}))}optional(){return this.term().skip(q).map(e=>({type:"optional",value:e}))}optionalGroup(){return this.expression().trim().wrap(u("["),u("]")).map(e=>({type:"optional",value:e}))}optionalWhitespace(){return this.term().skip(K).map(e=>({type:"optionalWhitespace",value:e}))}coalesce(){return w(this.term().skip(Z),this.factor()).map(([e,t])=>({type:"coalesce",value:[e,t]}))}subtraction(){return w(this.term().skip(Y),this.term()).map(([e,t])=>({type:"minus",value:[e,t]}))}manyGroup(){return this.expression().trim().wrap(u("{"),u("}")).map(e=>({type:"many",value:e}))}many(){return this.term().skip(J).map(e=>({type:"many",value:e}))}many1(){return this.term().skip(U).map(e=>({type:"many1",value:e}))}next(){return w(this.factor().skip(Q),h(this.skip(),this.factor())).map(([e,t])=>({type:"next",value:[e,t]}))}skip(){return w(h(this.next(),this.factor()).skip(V),this.factor()).map(([e,t])=>({type:"skip",value:[e,t]}))}concatenation(){return h(this.skip(),this.next(),this.factor()).sepBy(G,1).map(e=>({type:"concatenation",value:e}))}alternation(){return h(this.concatenation(),this.skip(),this.next(),this.factor()).sepBy(H,1).map(e=>({type:"alternation",value:e}))}bigComment(){return d(/\/\*[^]*?\*\//).trim().map(e=>({type:"comment",expression:{type:"literal",value:e}}))}term(){return h(this.epsilon(),this.literal(),this.nonterminal(),this.regex(),this.group(),this.optionalGroup(),this.manyGroup(),this.eof()).trim(this.bigComment().opt())}factor(){return h(this.coalesce(),this.optionalWhitespace(),this.optional(),this.many(),this.many1(),this.subtraction(),this.term())}comment(){return d(/\/\/.*/).trim().map(e=>({type:"comment",expression:{type:"literal",value:e}})).or(this.bigComment())}expression(){return h(this.alternation(),this.concatenation(),this.skip(),this.next(),this.factor())}productionRule(){return w(this.identifier().skip(P),this.expression().skip(X)).map(([e,t])=>({name:e,expression:t,type:"productionRule"}))}grammar(){return w(this.comment().many(),this.productionRule(),this.comment().many()).many(1).map(e=>e.flat(2))}}x([g],k.prototype,"group",1),x([g],k.prototype,"regex",1),x([g],k.prototype,"optionalGroup",1),x([g],k.prototype,"coalesce",1),x([g],k.prototype,"manyGroup",1),x([g],k.prototype,"next",1),x([g],k.prototype,"skip",1);function _(i){const e=new Set,t=[];function n(o,s){if(s.has(o)||e.has(o))return;s.add(o);const a=i.get(o);if(a){if(a.type==="nonterminal")n(a.value,s);else if(a.type==="concatenation"||a.type==="alternation")for(const c of a.value)c.type==="nonterminal"&&n(c.value,s);e.add(o),s.delete(o),t.unshift({name:o,expression:a})}}for(const[o]of i)n(o,new Set);const r=new Map;for(const o of t)r.set(o.name,o.expression);return r}const M=(i,e)=>{if(!(!(i!=null&&i.type)||!(e!=null&&e.type)||i.type!==e.type))switch(i.type){case"literal":case"nonterminal":return i.value!==e.value?void 0:[i,{type:"epsilon"},{type:"epsilon"}];case"group":case"optional":case"many":case"many1":{const t=M(i.value,e.value);return t?[{type:i.type,value:t[0]},{type:i.type,value:t[1]},{type:i.type,value:t[2]}]:void 0}case"concatenation":{const t=i.value.map((c,y)=>M(i.value[y],e.value[y]));if(t.some(c=>c===void 0))return;const n=t.map(c=>c[0]),r=t.map(c=>c[1]),o=t.map(c=>c[2]),s=n.lastIndexOf(null);return s===n.length-1?void 0:[{type:"concatenation",value:n.slice(s+1)},{type:"concatenation",value:r},{type:"concatenation",value:o}]}case"alternation":for(const t of i.value){const n=M(t,e);if(n)return n}for(const t of e.value){const n=M(i,t);if(n)return n}return}},b=(i,e)=>{if(i.type!==e.type)return!1;switch(i.type){case"literal":case"nonterminal":return i.value===e.value;case"group":case"optional":case"many":case"many1":return b(i.value,e.value);case"minus":case"skip":case"next":return b(i.value[0],e.value[0])&&b(i.value[1],e.value[1]);case"concatenation":return i.value.every((t,n)=>b(t,e.value[n]));case"alternation":return i.value.some((t,n)=>b(t,e.value[n]));case"epsilon":return!0}};function ee(i,e){const t=new Map;let n=null;for(let r=0;r<e.value.length-1;r++){const o=e.value[r],s=e.value[r+1],a=M(o,s);if(a){const[c,y,A]=a;n!==null&&b(c,n)?t.get(n).push(A):(t.set(c,[y,A]),n=c),r===e.value.length-2&&e.value.shift(),e.value.shift(),r-=1}}for(const[r,o]of t){const a={type:"concatenation",value:[{type:"group",value:{type:"alternation",value:o}},{type:"group",value:r}]};e.value.push(a)}}const te=(i,e,t)=>{const n=[],r=[],o={type:"nonterminal",value:t};for(let s=0;s<e.value.length;s++){const a=e.value[s];a.type==="concatenation"&&a.value[0].value===i?r.push({type:"concatenation",value:[...a.value.slice(1),o]}):n.push({type:"concatenation",value:[a,o]})}return r.length===0?[void 0,void 0]:(r.push({type:"epsilon"}),[{type:"alternation",value:n},{type:"alternation",value:r}])};function ne(i){const e=new Map;let t=0;for(const[n,r]of i)if(r.type==="alternation"){const o=`${n}_${t++}`,[s,a]=te(n,r,o);s&&(e.set(o,a),e.set(n,s))}if(e.size===0)return i;for(const[n,r]of e)i.set(n,r);for(const[n,r]of i)r.type==="alternation"&&ee(n,r)}function re(i){const e=_(i);return ne(e),e}function oe(i){function e(n,r){var o,s;switch(r.type){case"literal":return u(r.value);case"nonterminal":const a=f.lazy(()=>t[r.value]);return a.context.name=m.blue(r.value),a;case"comment":case"epsilon":return R().opt();case"eof":return R();case"group":return e(n,r.value);case"regex":return d(r.value);case"optionalWhitespace":return e(n,r.value).trim();case"coalesce":return h(...r.value.map(c=>e(n,c)));case"optional":return e(n,r.value).opt();case"many":return e(n,r.value).many();case"many1":return e(n,r.value).many(1);case"skip":return e(n,r.value[0]).skip(e(n,r.value[1]));case"next":return e(n,r.value[0]).next(e(n,r.value[1]));case"minus":return e(n,r.value[0]).not(e(n,r.value[1]));case"concatenation":{const c=r.value.map(y=>e(n,y));return((s=(o=c.at(-1))==null?void 0:o.context)==null?void 0:s.name)==="eof"&&c.pop(),w(...c)}case"alternation":return h(...r.value.map(c=>e(n,c)))}}const t={};for(const[n,r]of i.entries())t[n]=e(n,r);return t}function ie(i,e=!1){const t=new Map;let n=new k().grammar().trim().parse(i).reduce((o,{name:s,expression:a,type:c},y)=>(c==="comment"&&t.set(y,a.value),o.set(s,a),o),new Map);return e&&(n=re(n)),[oe(n),n]}const se=(i,e)=>{Object.entries(i).forEach(([t,n])=>{i[t]=n.debug(t,e)})};l.Parser=f,l.ParserState=v,l.addNonterminalsDebugging=se,l.all=w,l.any=h,l.eof=R,l.generateParserFromEBNF=ie,l.lazy=g,l.lookAhead=T,l.lookBehind=O,l.regex=d,l.string=u,l.whitespace=N,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
