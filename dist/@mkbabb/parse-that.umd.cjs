(function(p,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("chalk")):typeof define=="function"&&define.amd?define(["exports","chalk"],f):(p=typeof globalThis<"u"?globalThis:p||self,f(p.ParseThat={},p.chalk))})(this,function(p,f){"use strict";var fe=Object.defineProperty;var he=(p,f,b)=>f in p?fe(p,f,{enumerable:!0,configurable:!0,writable:!0,value:b}):p[f]=b;var _=(p,f,b)=>(he(p,typeof f!="symbol"?f+"":f,b),b);const R=(s,e=80)=>s.length<=80?s:s.slice(0,80)+"...";class N{constructor(e,t=void 0,n=0,r=!1){this.src=e,this.value=t,this.offset=n,this.isError=r}ok(e,t=0){return new N(this.src,e,this.offset+t)}err(e,t=0){const n=this.ok(e,t);return n.isError=!0,n}from(e,t=0){return new N(this.src,e,this.offset+t,this.isError)}getColumnNumber(){const e=this.offset,t=this.src.lastIndexOf(`
`,e),n=t===-1?e:e-(t+1);return Math.max(0,n)}getLineNumber(){const t=this.src.slice(0,this.offset).split(`
`).length-1;return Math.max(0,t)}addCursor(e="^",t=!1){const n=(t?f.red:f.green).bold,r=this.src.split(`
`),o=Math.min(r.length-1,this.getLineNumber()),i=Math.max(o-5,0),a=Math.min(o+5+1,r.length),u=r.slice(i,a).map(R);if(e){const $=" ".repeat(this.getColumnNumber())+n(e);u.splice(o-i+1,0,$)}const h=(a+"").length;return u.map(($,A)=>{const G=i+A+1,O=`${(G+"").padStart(h)} | ${$}`;return G===o+1?n(O):O}).join(`
`)}}const l=(s,...e)=>({name:s,args:e}),T=/\s*/y,B=s=>{var t;if(s.offset>=s.src.length)return s;T.lastIndex=s.offset;const e=((t=s.src.match(T))==null?void 0:t[0])??"";return s.ok(s.value,e.length)},E=new Map;let j=0,D=0;const S=new Map,I=new Map;class m{constructor(e,t={}){_(this,"id",D++);this.parser=e,this.context=t}parse(e){return S.clear(),E.clear(),I.clear(),this.parser(new N(e)).value}getCijKey(e){return`${this.id}${e.offset}`}atLeftRecursionLimit(e){return(I.get(this.getCijKey(e))??0)>e.src.length-e.offset}memoize(){const e=t=>{const n=this.getCijKey(t),r=I.get(n)??0;let o=S.get(this.id);if(o&&o.offset>=t.offset)return o;if(this.atLeftRecursionLimit(t))return t.err(void 0);I.set(n,r+1);const i=this.parser(t);return o=S.get(this.id),o&&o.offset>i.offset?i.offset=o.offset:o||S.set(this.id,i),i};return new m(e,l("memoize",this))}mergeMemos(){const e=t=>{let n=S.get(this.id);if(n)return n;if(this.atLeftRecursionLimit(t))return t.err(void 0);const r=this.parser(t);return n=S.get(this.id),n||S.set(this.id,r),r};return new m(e,l("mergeMemo",this))}then(e){const t=n=>{const r=this.parser(n);if(!r.isError){const o=e.parser(r);if(!o.isError)return o.ok([r.value,o.value])}return n.err(void 0)};return new m(t,l("then",e))}or(e){const t=n=>{const r=this.parser(n);return r.isError?e.parser(n):r};return new m(t,l("or",e))}chain(e,t=!1){const n=r=>{const o=this.parser(r);return o.isError?o:o.value||t?e(o.value).parser(o):r};return new m(n,l("chain",e))}map(e,t=!1){const n=r=>{const o=this.parser(r);return!o.isError||t?o.ok(e(o.value)):o};return new m(n,l("map",this))}skip(e){const t=n=>{const r=this.parser(n);if(!r.isError){const o=e.parser(r);if(!o.isError)return o.ok(r.value)}return n.err(void 0)};return new m(t,l("skip",e))}next(e){const t=this.then(e).map(([,n])=>n);return t.context=l("next",e),t}opt(){const e=t=>{const n=this.parser(t);return n.isError?t.ok(void 0):n};return new m(e,l("opt",this))}not(e){const t=r=>this.parser(r).isError?r.ok(r.value):r.err(void 0),n=r=>{const o=this.parser(r);return o.isError||e.parser(r).isError?o:r.err(void 0)};return new m(e?n:t,l("not",e))}wrap(e,t){const n=e.next(this).skip(t);return n.context=l("wrap",e,t),n}trim(e=z){var n;if(((n=e.context)==null?void 0:n.name)==="whitespace"){const r=o=>{const i=B(o),a=this.parser(i);return a.isError?o.err(void 0):B(a)};return new m(r,l("trim",e))}const t=this.wrap(e,e.opt());return t.context=l("trim",e),t}many(e=0,t=1/0){const n=r=>{const o=[];let i=r;for(let a=0;a<t;a+=1){const u=this.parser(i);if(u.isError)break;o.push(u.value),i=u}return o.length>=e?i.ok(o):r.err([])};return new m(n,l("many",e,t))}sepBy(e,t=0,n=1/0){const r=o=>{const i=[];let a=o;for(let u=0;u<n;u+=1){const h=this.parser(a);if(h.isError)break;a=h,i.push(a.value);const k=e.parser(a);if(k.isError)break;a=k}return i.length>t?a.ok(i):o.err([])};return new m(r,l("sepBy",e))}debug(e="",t=console.log){e=f.italic(e);const n=r=>{const o=this.parser(r),i=o.isError?f.bgRed:f.bgGreen,a=o.isError?f.red:f.green,u=o.offset>=o.src.length,h=o.isError?"ï½˜":u?"ðŸŽ‰":"âœ“",$=" "+(o.isError?"Err":u?"Done":"Ok")+" "+h+" ";let A=i.bold($)+a(`	${e}	${o.offset}	`);return A+=f.yellow(R(this.toString(),80-A.length)),t(A),o.offset>=o.src.length?t(f.bold.greenBright(o.addCursor("",o.isError)+`
`)):t(r.addCursor("^",o.isError)+`
`),o};return new m(n,l("debug",e,t))}eof(){const e=this.skip(C());return e.context=l("eof",this),e}static lazy(e){const t=j++,n=r=>{if(E.has(t))return E.get(t).parser(r);const o=e();return o.id=t,E.set(t,o),o.parser(r)};return new m(n,l("lazy",e))}toString(e=0){var r;const t=((r=this.context)==null?void 0:r.name)??"unknown",n=(()=>{switch(t){case"string":return`"${this.context.args[0]}"`;case"regex":return`${this.context.args[0]}`;case"wrap":case"trim":return`wrap(${this.context.args[0]}, ${this.context.args[1]})`;case"not":return`!${this.context.args[0]}`;case"opt":return`${this.context.args[0]}?`;case"next":return` (next ${this.context.args[0]}) `;case"skip":return` (skip ${this.context.args[0]}) `;case"then":return`( then ${this.context.args[0]}) `;case"map":return`${this.context.args[0].toString()}`;case"any":case"all":const i=t==="any"?" | ":" , ";return`(${this.context.args.map(a=>a.toString(e+1)).join(i)})`;case"many":return`${this.context.args[0]} ... ${this.context.args[1]}`;case"sepBy":return`sepBy ${this.context.args[0]}`;case"lazy":return`() => ${this.context.args[0]}`;case"debug":return`debug ${this.context.args[0]}`;case"memoize":return`memoize ${this.context.args[0]}`;case"mergeMemo":return`mergeMemo ${this.context.args[0]}`;case"eof":return`${this.context.args[0]} eof`}})();return n!==void 0?n:f.bold(t)}}function C(){const s=e=>e.offset>=e.src.length?e.ok(void 0):e.err();return new m(s,l("eof"))}function y(s,e,t){let n=t.value;const r=j++;t.value=function(){const o=i=>{if(E.has(r))return E.get(r).parser(i);const a=n.apply(this,arguments);return a.id=r,E.set(r,a),a.parser(i)};return new m(o,l("lazy",n))}}function v(...s){const e=t=>{for(const n of s){const r=n.parser(t);if(!r.isError)return r}return t.err(void 0)};return new m(s.length===1?s[0].parser:e,l("any",...s))}function d(...s){const e=t=>{const n=[];for(const r of s){const o=r.parser(t);if(o.isError)return o;o.value!==void 0&&n.push(o.value),t=o}return t.ok(n)};return new m(s.length===1?s[0].parser:e,l("all",...s))}function W(s){const e=t=>{const n=s.parser(t);return n.isError?t.err(void 0):t.ok(n.value)};return new m(e,l("lookAhead",s))}function X(s){const e=t=>{let n=s.parser(t);for(;n.offset>0&&n.isError;)n.offset-=1,n=s.parser(n);return n.isError?t.err(void 0):t.ok(n.value)};return new m(e,l("lookBehind",s))}function c(s){const e=t=>{if(t.offset>=t.src.length)return t.err(void 0);const n=t.src.slice(t.offset,t.offset+s.length);return n===s?t.ok(n,n.length):t.err(void 0)};return new m(e,l("string",s))}function g(s){const e=new RegExp(s,s.flags+"y"),t=n=>{var o;if(n.offset>=n.src.length)return n.err(void 0);e.lastIndex=n.offset;const r=(o=n.src.match(e))==null?void 0:o[0];return r?n.ok(r,r.length):r===""?n.ok(void 0):n.err(void 0)};return new m(t,l("regex",s))}const z=g(/\s*/);z.context.name="whitespace";var F=Object.defineProperty,H=Object.getOwnPropertyDescriptor,x=(s,e,t,n)=>{for(var r=n>1?void 0:n?H(e,t):e,o=s.length-1,i;o>=0;o--)(i=s[o])&&(r=(n?i(e,t,r):i(r))||r);return n&&r&&F(e,t,r),r};const P=c(",").trim(),q=c("=").trim(),K=c(";").trim(),Z=c(".").trim(),U=c("?").trim(),Y=c("?w").trim(),J=c("??").trim(),Q=c("|").trim(),V=c("+").trim(),ee=c("-").trim(),te=c("*").trim();c("/").trim();const ne=c(">>").trim(),re=c("<<").trim(),oe=v(K,Z);class w{identifier(){return g(/[_a-zA-Z][_a-zA-Z0-9]*/).trim()}literal(){return v(g(/[^"]+/).wrap(c('"'),c('"')),g(/[^']+/).wrap(c("'"),c("'"))).map(e=>({type:"literal",value:e}))}epsilon(){return v(c("epsilon"),c("Îµ"),c("Ïµ")).trim().map(e=>({type:"epsilon",value:void 0}))}nonterminal(){return this.identifier().map(e=>({type:"nonterminal",value:e}))}group(){return this.expression().trim().wrap(c("("),c(")")).map(e=>({type:"group",value:e}))}eof(){return c("$").trim().map(e=>({type:"eof",value:e}))}regex(){return g(/[^\/]*/).wrap(c("/"),c("/")).map(e=>({type:"regex",value:new RegExp(e)}))}optional(){return this.term().skip(U).map(e=>({type:"optional",value:e}))}optionalGroup(){return this.expression().trim().wrap(c("["),c("]")).map(e=>({type:"optional",value:e}))}optionalWhitespace(){return this.term().skip(Y).map(e=>({type:"optionalWhitespace",value:e}))}coalesce(){return d(this.term().skip(J),this.factor()).map(([e,t])=>({type:"coalesce",value:[e,t]}))}subtraction(){return d(this.term().skip(ee),this.term()).map(([e,t])=>({type:"minus",value:[e,t]}))}manyGroup(){return this.expression().trim().wrap(c("{"),c("}")).map(e=>({type:"many",value:e}))}many(){return this.term().skip(te).map(e=>({type:"many",value:e}))}many1(){return this.term().skip(V).map(e=>({type:"many1",value:e}))}next(){return d(this.factor().skip(ne),v(this.skip(),this.factor())).map(([e,t])=>({type:"next",value:[e,t]}))}skip(){return d(v(this.next(),this.factor()).skip(re),this.factor()).map(([e,t])=>({type:"skip",value:[e,t]}))}concatenation(){return v(this.skip(),this.next(),this.factor()).sepBy(P,1).map(e=>({type:"concatenation",value:e}))}alternation(){return v(this.concatenation(),this.skip(),this.next(),this.factor()).sepBy(Q,1).map(e=>({type:"alternation",value:e}))}bigComment(){return g(/\/\*[^]*?\*\//).trim().map(e=>({type:"comment",expression:{type:"literal",value:e}}))}term(){return v(this.epsilon(),this.literal(),this.nonterminal(),this.regex(),this.group(),this.optionalGroup(),this.manyGroup(),this.eof()).trim(this.bigComment().opt())}factor(){return v(this.coalesce(),this.optionalWhitespace(),this.optional(),this.many(),this.many1(),this.subtraction(),this.term())}comment(){return g(/\/\/.*/).trim().map(e=>({type:"comment",expression:{type:"literal",value:e}})).or(this.bigComment())}expression(){return v(this.alternation(),this.concatenation(),this.skip(),this.next(),this.factor())}productionRule(){return d(this.identifier().skip(q),this.expression().skip(oe)).map(([e,t])=>({name:e,expression:t,type:"productionRule"}))}grammar(){return d(this.comment().many(),this.productionRule(),this.comment().many()).many(1).map(e=>e.flat(2))}}x([y],w.prototype,"group",1),x([y],w.prototype,"regex",1),x([y],w.prototype,"optionalGroup",1),x([y],w.prototype,"coalesce",1),x([y],w.prototype,"manyGroup",1),x([y],w.prototype,"next",1),x([y],w.prototype,"skip",1);function se(s){const e=new Set,t=[];function n(o,i){if(i.has(o)||e.has(o))return;i.add(o);const a=s.get(o);if(a){if(a.type==="nonterminal")n(a.value,i);else if(a.type==="concatenation"||a.type==="alternation")for(const u of a.value)u.type==="nonterminal"&&n(u.value,i);e.add(o),i.delete(o),t.unshift({name:o,expression:a})}}for(const[o]of s)n(o,new Set);const r=new Map;for(const o of t)r.set(o.name,o.expression);return r}const M=(s,e)=>{if(!(!(s!=null&&s.type)||!(e!=null&&e.type)||s.type!==e.type))switch(s.type){case"literal":case"nonterminal":return s.value!==e.value?void 0:[s,{type:"epsilon"},{type:"epsilon"}];case"group":case"optional":case"many":case"many1":{const t=M(s.value,e.value);return t?[{type:s.type,value:t[0]},{type:s.type,value:t[1]},{type:s.type,value:t[2]}]:void 0}case"concatenation":{const t=s.value.map((u,h)=>M(s.value[h],e.value[h]));if(t.some(u=>u===void 0))return;const n=t.map(u=>u[0]),r=t.map(u=>u[1]),o=t.map(u=>u[2]),i=n.lastIndexOf(null);return i===n.length-1?void 0:[{type:"concatenation",value:n.slice(i+1)},{type:"concatenation",value:r},{type:"concatenation",value:o}]}case"alternation":for(const t of s.value){const n=M(t,e);if(n)return n}for(const t of e.value){const n=M(s,t);if(n)return n}return}},L=(s,e)=>{if(s.type!==e.type)return!1;switch(s.type){case"literal":case"nonterminal":return s.value===e.value;case"group":case"optional":case"many":case"many1":return L(s.value,e.value);case"minus":case"skip":case"next":return L(s.value[0],e.value[0])&&L(s.value[1],e.value[1]);case"concatenation":return s.value.every((t,n)=>L(t,e.value[n]));case"alternation":return s.value.some((t,n)=>L(t,e.value[n]));case"epsilon":return!0}};function ie(s,e){const t=new Map;let n=null;for(let r=0;r<e.value.length-1;r++){const o=e.value[r],i=e.value[r+1],a=M(o,i);if(a){const[u,h,k]=a;n!==null&&L(u,n)?t.get(n).push(k):(t.set(u,[h,k]),n=u),r===e.value.length-2&&e.value.shift(),e.value.shift(),r-=1}}for(const[r,o]of t){const a={type:"concatenation",value:[{type:"group",value:{type:"alternation",value:o}},{type:"group",value:r}]};e.value.push(a)}}const ae=(s,e,t)=>{const n=[],r=[],o={type:"nonterminal",value:t};for(let i=0;i<e.value.length;i++){const a=e.value[i];a.type==="concatenation"&&a.value[0].value===s?r.push({type:"concatenation",value:[...a.value.slice(1),o]}):n.push({type:"concatenation",value:[a,o]})}return r.length===0?[void 0,void 0]:(r.push({type:"epsilon"}),[{type:"alternation",value:n},{type:"alternation",value:r}])};function ue(s){const e=new Map;let t=0;for(const[n,r]of s)if(r.type==="alternation"){const o=`${n}_${t++}`,[i,a]=ae(n,r,o);i&&(e.set(o,a),e.set(n,i))}if(e.size===0)return s;for(const[n,r]of e)s.set(n,r);for(const[n,r]of s)r.type==="alternation"&&ie(n,r)}function ce(s){const e=se(s);return ue(e),e}function le(s){function e(n,r){var o,i;switch(r.type){case"literal":return c(r.value);case"nonterminal":const a=m.lazy(()=>t[r.value]);return a.context.name=f.blue(r.value),a;case"comment":case"epsilon":return C().opt();case"eof":return C();case"group":return e(n,r.value);case"regex":return g(r.value);case"optionalWhitespace":return e(n,r.value).trim();case"coalesce":return v(...r.value.map(u=>e(n,u)));case"optional":return e(n,r.value).opt();case"many":return e(n,r.value).many();case"many1":return e(n,r.value).many(1);case"skip":return e(n,r.value[0]).skip(e(n,r.value[1]));case"next":return e(n,r.value[0]).next(e(n,r.value[1]));case"minus":return e(n,r.value[0]).not(e(n,r.value[1]));case"concatenation":{const u=r.value.map(h=>e(n,h));return((i=(o=u.at(-1))==null?void 0:o.context)==null?void 0:i.name)==="eof"&&u.pop(),d(...u)}case"alternation":return v(...r.value.map(u=>e(n,u)))}}const t={};for(const[n,r]of s.entries())t[n]=e(n,r);return t}function pe(s,e=!1){const t=new Map;let n=new w().grammar().trim().parse(s).reduce((o,{name:i,expression:a,type:u},h)=>(u==="comment"&&t.set(h,a.value),o.set(i,a),o),new Map);return e&&(n=ce(n)),[le(n),n]}const me=(s,e)=>{Object.entries(s).forEach(([t,n])=>{s[t]=n.debug(t,e)})};p.Parser=m,p.ParserState=N,p.addNonterminalsDebugging=me,p.all=d,p.any=v,p.eof=C,p.generateParserFromEBNF=pe,p.lazy=y,p.lookAhead=W,p.lookBehind=X,p.regex=g,p.string=c,p.whitespace=z,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
