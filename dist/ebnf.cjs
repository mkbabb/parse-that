"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("./parse.cjs"),F=require("chalk");var N=Object.defineProperty,T=Object.getOwnPropertyDescriptor,v=(n,e,o,t)=>{for(var r=t>1?void 0:t?T(e,o):e,i=n.length-1,s;i>=0;i--)(s=n[i])&&(r=(t?s(e,o,r):s(r))||r);return t&&r&&N(e,o,r),r};const k=a.string(",").trim(),B=a.string("=").trim(),R=a.string(";").trim(),L=a.string(".").trim(),j=a.string("?").trim(),x=a.string("?w").trim(),A=a.string("??").trim(),z=a.string("|").trim(),G=a.string("+").trim(),M=a.string("-").trim(),_=a.string("*").trim();a.string("/").trim();const O=a.string(">>").trim(),I=a.string("<<").trim(),D=a.any(R,L);class p{identifier(){return a.regex(/[_a-zA-Z][_a-zA-Z0-9]*/).trim()}literal(){return a.any(a.regex(/[^"]+/).wrap(a.string('"'),a.string('"')),a.regex(/[^']+/).wrap(a.string("'"),a.string("'"))).map(e=>({type:"literal",value:e}))}epsilon(){return a.any(a.string("epsilon"),a.string("ε"),a.string("ϵ")).trim().map(e=>({type:"epsilon",value:void 0}))}nonterminal(){return this.identifier().map(e=>({type:"nonterminal",value:e}))}group(){return this.expression().trim().wrap(a.string("("),a.string(")")).map(e=>({type:"group",value:e}))}eof(){return a.string("$").trim().map(e=>({type:"eof",value:e}))}regex(){return a.regex(/[^\/]*/).wrap(a.string("/"),a.string("/")).map(e=>({type:"regex",value:new RegExp(e)}))}optional(){return this.term().skip(j).map(e=>({type:"optional",value:e}))}optionalGroup(){return this.expression().trim().wrap(a.string("["),a.string("]")).map(e=>({type:"optional",value:e}))}optionalWhitespace(){return this.term().skip(x).map(e=>({type:"optionalWhitespace",value:e}))}coalesce(){return a.all(this.term().skip(A),this.factor()).map(([e,o])=>({type:"coalesce",value:[e,o]}))}subtraction(){return a.all(this.term().skip(M),this.term()).map(([e,o])=>({type:"minus",value:[e,o]}))}manyGroup(){return this.expression().trim().wrap(a.string("{"),a.string("}")).map(e=>({type:"many",value:e}))}many(){return this.term().skip(_).map(e=>({type:"many",value:e}))}many1(){return this.term().skip(G).map(e=>({type:"many1",value:e}))}next(){return a.all(this.factor().skip(O),a.any(this.skip(),this.factor())).map(([e,o])=>({type:"next",value:[e,o]}))}skip(){return a.all(a.any(this.next(),this.factor()).skip(I),this.factor()).map(([e,o])=>({type:"skip",value:[e,o]}))}concatenation(){return a.any(this.skip(),this.next(),this.factor()).sepBy(k,1).map(e=>({type:"concatenation",value:e}))}alternation(){return a.any(this.concatenation(),this.skip(),this.next(),this.factor()).sepBy(z,1).map(e=>({type:"alternation",value:e}))}bigComment(){return a.regex(/\/\*[^]*?\*\//).trim().map(e=>({type:"comment",expression:{type:"literal",value:e}}))}term(){return a.any(this.epsilon(),this.literal(),this.nonterminal(),this.regex(),this.group(),this.optionalGroup(),this.manyGroup(),this.eof()).trim(this.bigComment().opt())}factor(){return a.any(this.coalesce(),this.optionalWhitespace(),this.optional(),this.many(),this.many1(),this.subtraction(),this.term())}comment(){return a.regex(/\/\/.*/).trim().map(e=>({type:"comment",expression:{type:"literal",value:e}})).or(this.bigComment())}expression(){return a.any(this.alternation(),this.concatenation(),this.skip(),this.next(),this.factor())}productionRule(){return a.all(this.identifier().skip(B),this.expression().skip(D)).map(([e,o])=>({name:e,expression:o,type:"productionRule"}))}grammar(){return a.all(this.comment().many(),this.productionRule(),this.comment().many()).many(1).map(e=>e.flat(2))}}v([a.lazy],p.prototype,"group",1);v([a.lazy],p.prototype,"regex",1);v([a.lazy],p.prototype,"optionalGroup",1);v([a.lazy],p.prototype,"coalesce",1);v([a.lazy],p.prototype,"manyGroup",1);v([a.lazy],p.prototype,"next",1);v([a.lazy],p.prototype,"skip",1);function d(n){const e=new Set,o=[];function t(i,s){if(s.has(i)||e.has(i))return;s.add(i);const u=n.get(i);if(u){if(u.type==="nonterminal")t(u.value,s);else if(u.type==="concatenation"||u.type==="alternation")for(const l of u.value)l.type==="nonterminal"&&t(l.value,s);e.add(i),s.delete(i),o.unshift({name:i,expression:u})}}for(const[i]of n)t(i,new Set);const r=new Map;for(const i of o)r.set(i.name,i.expression);return r}const y=(n,e)=>{if(!(!(n!=null&&n.type)||!(e!=null&&e.type)||n.type!==e.type))switch(n.type){case"literal":case"nonterminal":return n.value!==e.value?void 0:[n,{type:"epsilon"},{type:"epsilon"}];case"group":case"optional":case"many":case"many1":{const o=y(n.value,e.value);return o?[{type:n.type,value:o[0]},{type:n.type,value:o[1]},{type:n.type,value:o[2]}]:void 0}case"concatenation":{const o=n.value.map((l,m)=>y(n.value[m],e.value[m]));if(o.some(l=>l===void 0))return;const t=o.map(l=>l[0]),r=o.map(l=>l[1]),i=o.map(l=>l[2]),s=t.lastIndexOf(null);return s===t.length-1?void 0:[{type:"concatenation",value:t.slice(s+1)},{type:"concatenation",value:r},{type:"concatenation",value:i}]}case"alternation":for(const o of n.value){const t=y(o,e);if(t)return t}for(const o of e.value){const t=y(n,o);if(t)return t}return}},f=(n,e)=>{if(n.type!==e.type)return!1;switch(n.type){case"literal":case"nonterminal":return n.value===e.value;case"group":case"optional":case"many":case"many1":return f(n.value,e.value);case"minus":case"skip":case"next":return f(n.value[0],e.value[0])&&f(n.value[1],e.value[1]);case"concatenation":return n.value.every((o,t)=>f(o,e.value[t]));case"alternation":return n.value.some((o,t)=>f(o,e.value[t]));case"epsilon":return!0}};function w(n,e){const o=new Map;let t=null;for(let r=0;r<e.value.length-1;r++){const i=e.value[r],s=e.value[r+1],u=y(i,s);if(u){const[l,m,g]=u;t!==null&&f(l,t)?o.get(t).push(g):(o.set(l,[m,g]),t=l),r===e.value.length-2&&e.value.shift(),e.value.shift(),r-=1}}for(const[r,i]of o){const u={type:"concatenation",value:[{type:"group",value:{type:"alternation",value:i}},{type:"group",value:r}]};e.value.push(u)}}const q=(n,e,o)=>{const t=[],r=[],i={type:"nonterminal",value:o};for(let s=0;s<e.value.length;s++){const u=e.value[s];u.type==="concatenation"&&u.value[0].value===n?r.push({type:"concatenation",value:[...u.value.slice(1),i]}):t.push({type:"concatenation",value:[u,i]})}return r.length===0?[void 0,void 0]:(r.push({type:"epsilon"}),[{type:"alternation",value:t},{type:"alternation",value:r}])};function b(n){const e=new Map;let o=0;for(const[t,r]of n)if(r.type==="alternation"){const i=`${t}_${o++}`,[s,u]=q(t,r,i);s&&(e.set(i,u),e.set(t,s))}if(e.size===0)return n;for(const[t,r]of e)n.set(t,r);for(const[t,r]of n)r.type==="alternation"&&w(t,r)}function C(n){const e=(o,t)=>{t.type==="concatenation"&&t.value[0].type==="nonterminal"&&t.value[0].value===o&&(t.value.slice(1,t.value.length),t.value.shift())};for(const[o,t]of n)e(o,t)}function E(n){const e=d(n);return b(e),e}function W(n){function e(t,r){var i,s;switch(r.type){case"literal":return a.string(r.value);case"nonterminal":const u=a.Parser.lazy(()=>o[r.value]);return u.context.name=F.bold.blue(r.value),u;case"comment":case"epsilon":return a.eof().opt();case"eof":return a.eof();case"group":return e(t,r.value);case"regex":return a.regex(r.value);case"optionalWhitespace":return e(t,r.value).trim();case"coalesce":return a.any(...r.value.map(l=>e(t,l)));case"optional":return e(t,r.value).opt();case"many":return e(t,r.value).many();case"many1":return e(t,r.value).many(1);case"skip":return e(t,r.value[0]).skip(e(t,r.value[1]));case"next":return e(t,r.value[0]).next(e(t,r.value[1]));case"minus":return e(t,r.value[0]).not(e(t,r.value[1]));case"concatenation":{const l=r.value.map(m=>e(t,m));return((s=(i=l.at(-1))==null?void 0:i.context)==null?void 0:s.name)==="eof"&&l.pop(),a.all(...l)}case"alternation":return a.any(...r.value.map(l=>e(t,l)))}}const o={};for(const[t,r]of n.entries())o[t]=e(t,r);return o}function P(n,e=!1){const o=new Map,r=new p().grammar().trim().parse(n);if(!r)throw new Error("Failed to parse EBNF grammar");let i=r.reduce((u,{name:l,expression:m,type:g},$)=>(g==="comment"&&o.set($,m.value),u.set(l,m),u),new Map);return e&&(i=E(i)),[W(i),i]}const Z=(n,e)=>{Object.entries(n).forEach(([o,t])=>{n[o]=t.debug(o,e)})},h={};function H(n,e){const o=n.split(e);if(o.length===1)return n;n=o.map((r,i)=>i===o.length-1?e+r:i===0?r:r.split(",").length>1?`
	${e} `+r:e+r).join("");const t=66;if(n.length>t){let r=t;for(let i=0;i<n.length;i+=r){const s=i===0?t:i+r,u=n.indexOf(e,s);if(u===-1)break;n=n.slice(0,u)+`
	${e}`+n.slice(u+1)}}return n}const J=["symbol","identifier","terminal","pipe","comma","plus","minus","star","div","question","eof","optional_whitespace","regex","rhs","rule","grammar"],S=n=>{const[e,o]=P(n);for(const t of J)e[t]=e[t].trim();return e.symbol=e.symbol,e.identifier=e.identifier.map(t=>t.flat().join("")),e.terminal=e.terminal.map(t=>t.flat().join("")),e.regex=e.regex.map(t=>t.flat().join("")),e.rhs=e.rhs.map(t=>{const i=(t instanceof Array?t.flat(1/0):t).join(" ");return H(i,"|")}),e.rule=e.rule.map(t=>t.flat().join(" ")),e.grammar.map(t=>{let r=0;for(let i=0;i<t.length;i++){const s=t[i];s.length>80?(t[i]=s+`
`,i>0&&r!==i-1&&(t[i-1]=t[i-1]+`
`),r=i):i-r>2&&(t[i]=s+`
`,r=i)}return t.join(`
`)})},K=(n,e,o)=>{const t=h.readFileSync(e,"utf8"),i=S(t).parse(n);return o!==void 0&&h.writeFileSync(o,i),i};function Q(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function c(n){switch(n.type){case"literal":return Q(n.value);case"nonterminal":return`($${n.value})`;case"epsilon":return"";case"group":return`(${c(n.value)})`;case"regex":return n.value.source;case"optional":return`(${c(n.value)})?`;case"minus":return`${c(n.value[0])}(?!${c(n.value[1])})`;case"many":return`(${c(n.value)})*`;case"many1":return`(${c(n.value)})+`;case"skip":return`${c(n.value[0])}(?:${c(n.value[1])})?`;case"next":return`${c(n.value[0])}(?=${c(n.value[1])})`;case"concatenation":return n.value.map(c).join("");case"alternation":return n.value.map(e=>`(${c(e)})`).join("|")}}function U(n){const e=[];for(const[o,t]of n)e.push({name:o,match:c(t)});return{name:"EEBNF",scopeName:"source.eebnf",fileTypes:["eebnf"],patterns:e}}exports.EBNFGrammar=p;exports.EBNFParser=S;exports.addNonterminalsDebugging=Z;exports.comparePrefix=f;exports.findCommonPrefix=y;exports.formatEBNFGrammar=K;exports.generateParserFromEBNF=P;exports.removeAllLeftRecursion=E;exports.removeDirectLeftRecursion=b;exports.removeIndirectLeftRecursion=C;exports.rewriteTreeLeftRecursion=w;exports.topologicalSort=d;exports.transformEBNFASTToTextMateLanguage=U;
