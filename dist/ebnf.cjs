"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("./parse.cjs"),N=require("chalk");var $=Object.defineProperty,B=Object.getOwnPropertyDescriptor,f=(n,e,a,t)=>{for(var r=t>1?void 0:t?B(e,a):e,i=n.length-1,s;i>=0;i--)(s=n[i])&&(r=(t?s(e,a,r):s(r))||r);return t&&r&&$(e,a,r),r};const k=o.string(",").trim(),A=o.string("=").trim(),R=o.string(";").trim(),x=o.string(".").trim(),L=o.string("?").trim(),j=o.string("?w").trim(),z=o.string("??").trim(),G=o.string("|").trim(),_=o.string("+").trim(),M=o.string("-").trim(),O=o.string("*").trim();o.string("/").trim();const I=o.string(">>").trim(),D=o.string("<<").trim(),q=o.any(R,x);class m{identifier(){return o.regex(/[_a-zA-Z][_a-zA-Z0-9]*/).trim()}literal(){return o.any(o.regex(/[^"]+/).wrap(o.string('"'),o.string('"')),o.regex(/[^']+/).wrap(o.string("'"),o.string("'"))).map(e=>({type:"literal",value:e}))}epsilon(){return o.any(o.string("epsilon"),o.string("ε"),o.string("ϵ")).trim().map(e=>({type:"epsilon",value:void 0}))}nonterminal(){return this.identifier().map(e=>({type:"nonterminal",value:e}))}group(){return this.expression().trim().wrap(o.string("("),o.string(")")).map(e=>({type:"group",value:e}))}eof(){return o.string("$").trim().map(e=>({type:"eof",value:e}))}regex(){return o.regex(/[^\/]*/).wrap(o.string("/"),o.string("/")).map(e=>({type:"regex",value:new RegExp(e)}))}optional(){return this.term().skip(L).map(e=>({type:"optional",value:e}))}optionalGroup(){return this.expression().trim().wrap(o.string("["),o.string("]")).map(e=>({type:"optional",value:e}))}optionalWhitespace(){return this.term().skip(j).map(e=>({type:"optionalWhitespace",value:e}))}coalesce(){return o.all(this.term().skip(z),this.factor()).map(([e,a])=>({type:"coalesce",value:[e,a]}))}subtraction(){return o.all(this.term().skip(M),this.term()).map(([e,a])=>({type:"minus",value:[e,a]}))}manyGroup(){return this.expression().trim().wrap(o.string("{"),o.string("}")).map(e=>({type:"many",value:e}))}many(){return this.term().skip(O).map(e=>({type:"many",value:e}))}many1(){return this.term().skip(_).map(e=>({type:"many1",value:e}))}next(){return o.all(this.factor().skip(I),o.any(this.skip(),this.factor())).map(([e,a])=>({type:"next",value:[e,a]}))}skip(){return o.all(o.any(this.next(),this.factor()).skip(D),this.factor()).map(([e,a])=>({type:"skip",value:[e,a]}))}concatenation(){return o.any(this.skip(),this.next(),this.factor()).sepBy(k,1).map(e=>({type:"concatenation",value:e}))}alternation(){return o.any(this.concatenation(),this.skip(),this.next(),this.factor()).sepBy(G,1).map(e=>({type:"alternation",value:e}))}bigComment(){return o.regex(/\/\*[^]*?\*\//).trim().map(e=>({type:"comment",expression:{type:"literal",value:e}}))}term(){return o.any(this.epsilon(),this.literal(),this.nonterminal(),this.regex(),this.group(),this.optionalGroup(),this.manyGroup(),this.eof()).trim(this.bigComment().opt())}factor(){return o.any(this.coalesce(),this.optionalWhitespace(),this.optional(),this.many(),this.many1(),this.subtraction(),this.term())}comment(){return o.regex(/\/\/.*/).trim().map(e=>({type:"comment",expression:{type:"literal",value:e}})).or(this.bigComment())}expression(){return o.any(this.alternation(),this.concatenation(),this.skip(),this.next(),this.factor())}productionRule(){return o.all(this.identifier().skip(A),this.expression().skip(q)).map(([e,a])=>({name:e,expression:a,type:"productionRule"}))}grammar(){return o.all(this.comment().many(),this.productionRule(),this.comment().many()).many(1).map(e=>e.flat(2))}}f([o.lazy],m.prototype,"group",1);f([o.lazy],m.prototype,"regex",1);f([o.lazy],m.prototype,"optionalGroup",1);f([o.lazy],m.prototype,"coalesce",1);f([o.lazy],m.prototype,"manyGroup",1);f([o.lazy],m.prototype,"next",1);f([o.lazy],m.prototype,"skip",1);function d(n){const e=new Set,a=[];function t(i,s){if(s.has(i)||e.has(i))return;s.add(i);const u=n.get(i);if(u){if(u.type==="nonterminal")t(u.value,s);else if(u.type==="concatenation"||u.type==="alternation")for(const l of u.value)l.type==="nonterminal"&&t(l.value,s);e.add(i),s.delete(i),a.unshift({name:i,expression:u})}}for(const[i]of n)t(i,new Set);const r=new Map;for(const i of a)r.set(i.name,i.expression);return r}const v=(n,e)=>{if(!(!(n!=null&&n.type)||!(e!=null&&e.type)||n.type!==e.type))switch(n.type){case"literal":case"nonterminal":return n.value!==e.value?void 0:[n,{type:"epsilon"},{type:"epsilon"}];case"group":case"optional":case"many":case"many1":{const a=v(n.value,e.value);return a?[{type:n.type,value:a[0]},{type:n.type,value:a[1]},{type:n.type,value:a[2]}]:void 0}case"concatenation":{const a=n.value.map((l,y)=>v(n.value[y],e.value[y]));if(a.some(l=>l===void 0))return;const t=a.map(l=>l[0]),r=a.map(l=>l[1]),i=a.map(l=>l[2]),s=t.lastIndexOf(null);return s===t.length-1?void 0:[{type:"concatenation",value:t.slice(s+1)},{type:"concatenation",value:r},{type:"concatenation",value:i}]}case"alternation":for(const a of n.value){const t=v(a,e);if(t)return t}for(const a of e.value){const t=v(n,a);if(t)return t}return}},p=(n,e)=>{if(n.type!==e.type)return!1;switch(n.type){case"literal":case"nonterminal":return n.value===e.value;case"group":case"optional":case"many":case"many1":return p(n.value,e.value);case"minus":case"skip":case"next":return p(n.value[0],e.value[0])&&p(n.value[1],e.value[1]);case"concatenation":return n.value.every((a,t)=>p(a,e.value[t]));case"alternation":return n.value.some((a,t)=>p(a,e.value[t]));case"epsilon":return!0}};function w(n,e){const a=new Map;let t=null;for(let r=0;r<e.value.length-1;r++){const i=e.value[r],s=e.value[r+1],u=v(i,s);if(u){const[l,y,g]=u;t!==null&&p(l,t)?a.get(t).push(g):(a.set(l,[y,g]),t=l),r===e.value.length-2&&e.value.shift(),e.value.shift(),r-=1}}for(const[r,i]of a){const u={type:"concatenation",value:[{type:"group",value:{type:"alternation",value:i}},{type:"group",value:r}]};e.value.push(u)}}const C=(n,e,a)=>{const t=[],r=[],i={type:"nonterminal",value:a};for(let s=0;s<e.value.length;s++){const u=e.value[s];u.type==="concatenation"&&u.value[0].value===n?r.push({type:"concatenation",value:[...u.value.slice(1),i]}):t.push({type:"concatenation",value:[u,i]})}return r.length===0?[void 0,void 0]:(r.push({type:"epsilon"}),[{type:"alternation",value:t},{type:"alternation",value:r}])};function b(n){const e=new Map;let a=0;for(const[t,r]of n)if(r.type==="alternation"){const i=`${t}_${a++}`,[s,u]=C(t,r,i);s&&(e.set(i,u),e.set(t,s))}if(e.size===0)return n;for(const[t,r]of e)n.set(t,r);for(const[t,r]of n)r.type==="alternation"&&w(t,r)}function W(n){const e=(a,t)=>{t.type==="concatenation"&&t.value[0].type==="nonterminal"&&t.value[0].value===a&&(t.value.slice(1,t.value.length),t.value.shift())};for(const[a,t]of n)e(a,t)}function F(n){const e=d(n);return b(e),e}function S(n){const a=new m().grammar().trim().parse(n);if(!a)throw new Error("Failed to parse EBNF grammar");return a.reduce((t,{name:r,expression:i,type:s},u)=>(t.set(r,i),t),new Map)}function E(n){function e(t,r){var i,s;switch(r.type){case"literal":return o.string(r.value);case"nonterminal":const u=o.Parser.lazy(()=>a[r.value]);return u.context.name=N.bold.blue(r.value),u;case"comment":case"epsilon":return o.eof().opt();case"eof":return o.eof();case"group":return e(t,r.value);case"regex":return o.regex(r.value);case"optionalWhitespace":return e(t,r.value).trim();case"coalesce":return o.any(...r.value.map(l=>e(t,l)));case"optional":return e(t,r.value).opt();case"many":return e(t,r.value).many();case"many1":return e(t,r.value).many(1);case"skip":return e(t,r.value[0]).skip(e(t,r.value[1]));case"next":return e(t,r.value[0]).next(e(t,r.value[1]));case"minus":return e(t,r.value[0]).not(e(t,r.value[1]));case"concatenation":{const l=r.value.map(y=>e(t,y));return((s=(i=l.at(-1))==null?void 0:i.context)==null?void 0:s.name)==="eof"&&l.pop(),o.all(...l)}case"alternation":return o.any(...r.value.map(l=>e(t,l)))}}const a={};for(const[t,r]of n.entries())a[t]=e(t,r);return a}function P(n,e=!1){let a=S(n);return e&&(a=F(a)),[E(a),a]}const Z=(n,e)=>{Object.entries(n).forEach(([a,t])=>{n[a]=t.debug(a,!1,e)})},h={};function H(n,e){const a=n.split(e);if(a.length===1)return n;n=a.map((r,i)=>i===a.length-1?e+r:i===0?r:r.split(",").length>1?`
	${e} `+r:e+r).join("");const t=66;if(n.length>t){let r=t;for(let i=0;i<n.length;i+=r){const s=i===0?t:i+r,u=n.indexOf(e,s);if(u===-1)break;n=n.slice(0,u)+`
	${e}`+n.slice(u+1)}}return n}const J=["symbol","identifier","terminal","pipe","comma","plus","minus","star","div","question","eof","optional_whitespace","regex","rhs","rule","grammar"],T=n=>{const[e,a]=P(n);for(const t of J)e[t]=e[t].trim();return e.symbol=e.symbol,e.identifier=e.identifier.map(t=>t.flat().join("")),e.terminal=e.terminal.map(t=>t.flat().join("")),e.regex=e.regex.map(t=>t.flat().join("")),e.rhs=e.rhs.map(t=>{const i=(t instanceof Array?t.flat(1/0):t).join(" ");return H(i,"|")}),e.rule=e.rule.map(t=>t.flat().join(" ")),e.grammar.map(t=>{let r=0;for(let i=0;i<t.length;i++){const s=t[i];s.length>80?(t[i]=s+`
`,i>0&&r!==i-1&&(t[i-1]=t[i-1]+`
`),r=i):i-r>2&&(t[i]=s+`
`,r=i)}return t.join(`
`)})},K=(n,e,a)=>{const t=h.readFileSync(e,"utf8"),i=T(t).parse(n);return a!==void 0&&h.writeFileSync(a,i),i};function Q(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function c(n){switch(n.type){case"literal":return Q(n.value);case"nonterminal":return`($${n.value})`;case"epsilon":return"";case"group":return`(${c(n.value)})`;case"regex":return n.value.source;case"optional":return`(${c(n.value)})?`;case"minus":return`${c(n.value[0])}(?!${c(n.value[1])})`;case"many":return`(${c(n.value)})*`;case"many1":return`(${c(n.value)})+`;case"skip":return`${c(n.value[0])}(?:${c(n.value[1])})?`;case"next":return`${c(n.value[0])}(?=${c(n.value[1])})`;case"concatenation":return n.value.map(c).join("");case"alternation":return n.value.map(e=>`(${c(e)})`).join("|")}}function U(n){const e=[];for(const[a,t]of n)e.push({name:a,match:c(t)});return{name:"EEBNF",scopeName:"source.eebnf",fileTypes:["eebnf"],patterns:e}}exports.EBNFGrammar=m;exports.EBNFParser=T;exports.addNonterminalsDebugging=Z;exports.comparePrefix=p;exports.findCommonPrefix=v;exports.formatEBNFGrammar=K;exports.generateASTFromEBNF=S;exports.generateParserFromAST=E;exports.generateParserFromEBNF=P;exports.removeAllLeftRecursion=F;exports.removeDirectLeftRecursion=b;exports.removeIndirectLeftRecursion=W;exports.rewriteTreeLeftRecursion=w;exports.topologicalSort=d;exports.transformEBNFASTToTextMateLanguage=U;
